{"title":"FastAPI项目 从构建到部署","uid":"bf51339dcad20c031f2ba03575ee26be","slug":"FastAPI项目-从构建到部署","date":"2024-09-24T09:31:51.000Z","updated":"2024-10-06T07:46:02.345Z","comments":true,"path":"api/articles/FastAPI项目-从构建到部署.json","keywords":null,"cover":[],"content":"<h1 id=\"FastAPI项目-从构建到部署\"><a href=\"#FastAPI项目-从构建到部署\" class=\"headerlink\" title=\"FastAPI项目 从构建到部署\"></a>FastAPI项目 从构建到部署</h1><h2 id=\"项目框架基本结构\"><a href=\"#项目框架基本结构\" class=\"headerlink\" title=\"项目框架基本结构\"></a>项目框架基本结构</h2><p><strong>FastAPI</strong></p>\n<ul>\n<li><p><strong>路由, 视图</strong></p>\n<ul>\n<li>APIRouter</li>\n<li>Include_router</li>\n<li>Jinja2</li>\n</ul>\n</li>\n<li><p><strong>中间件</strong></p>\n<ul>\n<li>cookie</li>\n<li>session</li>\n<li>request, response</li>\n</ul>\n</li>\n<li><p><strong>安全</strong></p>\n<ul>\n<li><strong>JWT</strong></li>\n<li><strong>RBAC</strong></li>\n<li>Depends</li>\n<li>Exception</li>\n</ul>\n</li>\n<li><p><strong>第三方库</strong></p>\n<ul>\n<li>短信</li>\n<li>支付(微信, 支付宝)</li>\n<li><strong>数据库(MySQL, pg)</strong></li>\n<li><strong>缓存(File, Redis)</strong></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"项目架构\"><a href=\"#项目架构\" class=\"headerlink\" title=\"项目架构\"></a>项目架构</h3><div class=\"language-txt\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">txt</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #babed8\"></span></span></code></pre></div><h2 id=\"项目基础构建\"><a href=\"#项目基础构建\" class=\"headerlink\" title=\"项目基础构建\"></a>项目基础构建</h2><h3 id=\"事件监听\"><a href=\"#事件监听\" class=\"headerlink\" title=\"事件监听\"></a>事件监听</h3><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">add_event_handler</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">startup</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> startup</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">application</span><span style=\"color: #89DDFF\">))</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">add_event_handler</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">shutdown</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> stopping</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">application</span><span style=\"color: #89DDFF\">))</span></span></code></pre></div><p>启动时调用<code>startup()</code>函数, 关闭时调用<code>stopping()</code>函数</p>\n<p><code>startup</code>函数:</p>\n<div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">startup</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">app</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> FastAPI</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">-&gt;</span><span style=\"color: #BABED8\"> Callable</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    FastApi 启动完成事件</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :param app: FastAPI</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :return: start_app</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #C792EA\">async</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">app_start</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">-&gt;</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">None:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># APP启动完成后触发</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #82AAFF\">print</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">启动完毕</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF; font-style: italic\">pass</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> app_start</span></span></code></pre></div><h3 id=\"异常错误处理\"><a href=\"#异常错误处理\" class=\"headerlink\" title=\"异常错误处理\"></a>异常错误处理</h3><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">add_exception_handler</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">HTTPException</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> http_error_handler</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #676E95; font-style: italic\"># http错误 需实现http_error_handler</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">add_exception_handler</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">RequestValidationError</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> http422_error_handler</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #676E95; font-style: italic\"># 验证错误 需实现http422_error_handler</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">add_exception_handler</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">UnicornException</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> unicorn_exception_handler</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #676E95; font-style: italic\"># 启动错误 需实现unicorn_exception_handler</span></span></code></pre></div><p><code>http_error_handler</code>实现</p>\n<div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #C792EA\">async</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">http_error_handler</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">_</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> Request</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">exc</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> HTTPException</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    http异常处理</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :param _:</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :param exc:</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :return:</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">JSONResponse</span><span style=\"color: #89DDFF\">(&#123;</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">code</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #82AAFF\"> exc</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">status_code</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">message</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #82AAFF\"> exc</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">detail</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">data</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #82AAFF\"> exc</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">detail</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #89DDFF\">&#125;,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">status_code</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">exc</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">status_code</span><span style=\"color: #89DDFF\">)</span></span></code></pre></div><h3 id=\"路由\"><a href=\"#路由\" class=\"headerlink\" title=\"路由\"></a>路由</h3><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #BABED8\">router </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">APIRouter</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">include_router</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">router</span><span style=\"color: #89DDFF\">)</span></span></code></pre></div><h3 id=\"中间件\"><a href=\"#中间件\" class=\"headerlink\" title=\"中间件\"></a>中间件</h3><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">add_middleware</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">Middleware</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #676E95; font-style: italic\"># 手动实现session</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\"># session</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">add_middleware</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    SessionMiddleware</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">secret_key</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">session</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">session_cookie</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">f_id</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #676E95; font-style: italic\"># max_age=4</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\"># 跨域请求</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">add_middleware</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    CORSMiddleware</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">allow_origins</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">settings</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CORS_ORIGINS</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">allow_credentials</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">settings</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CORS_ALLOW_CREDENTIALS</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">allow_methods</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">settings</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CORS_ALLOW_METHODS</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">allow_headers</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">settings</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CORS_ALLOW_HEADERS</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">)</span></span></code></pre></div><h2 id=\"路由-1\"><a href=\"#路由-1\" class=\"headerlink\" title=\"路由\"></a>路由</h2><ul>\n<li><p>用一个文件来统一管理路由, 避免混乱</p>\n<div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #BABED8\">api_router </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">APIRouter</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">prefix</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">/api/v1</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">api_router</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">post</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">/test/oath2</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">测试oath2授权</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">])(</span><span style=\"color: #82AAFF\">test_oath2</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">api_router</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">include_router</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">user</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">router</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">prefix</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">/admin</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">用户管理</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">])</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">api_router</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">include_router</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">role</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">router</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">prefix</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">/admin</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">角色管理</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">])</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">api_router</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">include_router</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">access</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">router</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">prefix</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">/admin</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">权限管理</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">])</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">api_router</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">include_router</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">websocket</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">router</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">prefix</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">/ws</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">WebSocket</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">])</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">api_router</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">include_router</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">wechat</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">router</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">prefix</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">/wechat</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">微信授权</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">])</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">api_router</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">include_router</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">sms</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">router</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">prefix</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">/sms</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">短信接口</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">])</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">api_router</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">include_router</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">cos</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">router</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">prefix</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">/cos</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">对象存储接口</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">])</span></span></code></pre></div></li>\n<li><p>归类于总结注释:</p>\n<div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #BABED8\">ApiRouter</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">get</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">/index</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">api路由</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">],</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">summary</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">注册接口</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)(</span><span style=\"color: #82AAFF\">index</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">ApiRouter</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">post</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">/login</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">tags</span><span style=\"color: #89DDFF\">=[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">api路由</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">],</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">summary</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">登陆接口</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)(</span><span style=\"color: #82AAFF\">login</span><span style=\"color: #89DDFF\">)</span></span></code></pre></div><p><img src=\"https://raw.githubusercontent.com/Myprefer/ImageHost/main/20240929165137.png\"></p>\n</li>\n<li><p><a href=\"http://127.0.0.1:8000/redoc\">http://127.0.0.1:8000/redoc</a> api文档<br><img src=\"https://raw.githubusercontent.com/Myprefer/ImageHost/main/20240929165445.png\"></p>\n</li>\n</ul>\n<h2 id=\"ORM数据库\"><a href=\"#ORM数据库\" class=\"headerlink\" title=\"ORM数据库\"></a>ORM数据库</h2><h4 id=\"数据库配置\"><a href=\"#数据库配置\" class=\"headerlink\" title=\"数据库配置\"></a>数据库配置</h4><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #BABED8\">DB_ORM_CONFIG </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">connections</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">base</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">engine</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">tortoise.backends.mysql</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">credentials</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">host</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getenv</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">BASE_HOST</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">127.0.0.1</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">),</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">user</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getenv</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">BASE_USER</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">root</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">),</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">password</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getenv</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">BASE_PASSWORD</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">123456</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">),</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">port</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">int</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getenv</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">BASE_PORT</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">3306</span><span style=\"color: #89DDFF\">)),</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">database</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getenv</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">BASE_DB</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">base</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">),</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF\">&#125;,</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF\">&#125;,</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">apps</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">base</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#123;</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">models</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">models.base</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">],</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">default_connection</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">base</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF\">&#125;,</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">use_tz</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">False,</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">timezone</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">Asia/Shanghai</span><span style=\"color: #89DDFF\">&#39;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">async</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">register_mysql</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">app</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> FastAPI</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 注册数据库</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #82AAFF\">register_tortoise</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        app</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #BABED8; font-style: italic\">config</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">DB_ORM_CONFIG</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #BABED8; font-style: italic\">generate_schemas</span><span style=\"color: #89DDFF\">=False,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #676E95; font-style: italic\"># 是否自动创建数据库</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #BABED8; font-style: italic\">add_exception_handlers</span><span style=\"color: #89DDFF\">=True,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #89DDFF\">)</span></span></code></pre></div><ul>\n<li>可先完成代码, 后直接生成表, 防止数据类型冲突</li>\n</ul>\n<h4 id=\"数据库模型示例\"><a href=\"#数据库模型示例\" class=\"headerlink\" title=\"数据库模型示例\"></a>数据库模型示例</h4><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #C792EA\">class</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">User</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #FFCB6B\">Model</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    username </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">CharField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">null</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">max_length</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">20</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">用户名</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #FFCB6B\">type</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">BooleanField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">default</span><span style=\"color: #89DDFF\">=False,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">用户类型 True:超级管理员 False:普通管理员</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    password </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">CharField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">null</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">max_length</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">255</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    nickname </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">CharField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">default</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">binkuolo</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">max_length</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">255</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">昵称</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    u_phone </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">CharField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">null</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">手机号</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">max_length</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">11</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    u_email </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">CharField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">null</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">邮箱</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">max_length</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">255</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    full_name </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">CharField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">null</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">姓名</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">max_length</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">255</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    u_status </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">IntField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">default</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">0未激活 1正常 2禁用</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    head_img </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">CharField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">null</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">max_length</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">255</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">头像</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    sex </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">IntField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">default</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">null</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">0未知 1男 2女</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    remarks </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">CharField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">null</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">max_length</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">30</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">备注</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    client_host </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">CharField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">null</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">max_length</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">19</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">访问IP</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    create_time </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">DatetimeField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">auto_now_add</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">创建时间</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    update_time </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> fields</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">DatetimeField</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">auto_now</span><span style=\"color: #89DDFF\">=True,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">description</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">更新时间</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #C792EA\">class</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">Meta</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        table_description </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">用户</span><span style=\"color: #89DDFF\">&quot;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        table </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">user</span><span style=\"color: #89DDFF\">&quot;</span></span></code></pre></div><h2 id=\"缓存数据库Redis\"><a href=\"#缓存数据库Redis\" class=\"headerlink\" title=\"缓存数据库Redis\"></a>缓存数据库Redis</h2><h4 id=\"连接配置\"><a href=\"#连接配置\" class=\"headerlink\" title=\"连接配置\"></a>连接配置</h4><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #C792EA\">async</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">sys_cache</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">-&gt;</span><span style=\"color: #BABED8\"> Redis</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    系统缓存</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :return: cache 连接池</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 从URL方式创建redis连接池</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    sys_cache_pool </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> aioredis</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">ConnectionPool</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">from_url</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #C792EA\">f</span><span style=\"color: #C3E88D\">&quot;redis://</span><span style=\"color: #F78C6C\">&#123;</span><span style=\"color: #82AAFF\">os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getenv</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">CACHE_HOST</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">127.0.0.1</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #F78C6C\">&#125;</span><span style=\"color: #C3E88D\">:</span><span style=\"color: #F78C6C\">&#123;</span><span style=\"color: #82AAFF\">os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getenv</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">CACHE_PORT</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">6379</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #F78C6C\">&#125;</span><span style=\"color: #C3E88D\">&quot;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #BABED8; font-style: italic\">db</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getenv</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">CACHE_DB</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">),</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #BABED8; font-style: italic\">encoding</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">utf-8</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">        </span><span style=\"color: #BABED8; font-style: italic\">decode_responses</span><span style=\"color: #89DDFF\">=True</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">Redis</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">connection_pool</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">sys_cache_pool</span><span style=\"color: #89DDFF\">)</span></span></code></pre></div><h4 id=\"数据库查询\"><a href=\"#数据库查询\" class=\"headerlink\" title=\"数据库查询\"></a>数据库查询</h4><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #C792EA\">async</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">test_my_redis_depends</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">today</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">int</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">cache</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> Redis </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">Depends</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">sys_cache</span><span style=\"color: #89DDFF\">)):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 连接池放在依赖注入</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># await cache.set(name=&quot;today&quot;, value=today)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">await</span><span style=\"color: #BABED8\"> cache</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">set</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">name</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">ex_today</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">value</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">today</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">ex</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">60</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #676E95; font-style: italic\"># ex 过期时间</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># value = await cache.get(&quot;today&quot;)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">success</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">msg</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #C792EA\">f</span><span style=\"color: #C3E88D\">&quot;今天是</span><span style=\"color: #F78C6C\">&#123;</span><span style=\"color: #82AAFF\">today</span><span style=\"color: #F78C6C\">&#125;</span><span style=\"color: #C3E88D\">号&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">data</span><span style=\"color: #89DDFF\">=[])</span></span></code></pre></div><h2 id=\"中间件-1\"><a href=\"#中间件-1\" class=\"headerlink\" title=\"中间件\"></a>中间件</h2><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #BABED8\">application</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">add_middleware</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    CORSMiddleware</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">allow_origins</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">settings</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CORS_ORIGINS</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">allow_credentials</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">settings</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CORS_ALLOW_CREDENTIALS</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">allow_methods</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">settings</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CORS_ALLOW_METHODS</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">    </span><span style=\"color: #BABED8; font-style: italic\">allow_headers</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">settings</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CORS_ALLOW_HEADERS</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">)</span></span></code></pre></div><h4 id=\"Session\"><a href=\"#Session\" class=\"headerlink\" title=\"Session\"></a>Session</h4><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #C792EA\">async</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">__call__</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F07178; font-style: italic\">self</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">scope</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> Scope</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">receive</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> Receive</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">send</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\"> Send</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">-&gt;</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">None:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> scope</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">type</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">not</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">in</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">http</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">websocket</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">):</span><span style=\"color: #BABED8\">  </span><span style=\"color: #676E95; font-style: italic\"># pragma: no cover</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF; font-style: italic\">await</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">app</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">scope</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> receive</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> send</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF; font-style: italic\">return</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        start_time </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> time</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">time</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        req </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">Request</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">scope</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> receive</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> send</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">not</span><span style=\"color: #BABED8\"> req</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">session</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">get</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">session</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            req</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">session</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setdefault</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">session</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> random_str</span><span style=\"color: #89DDFF\">())</span></span></code></pre></div><h2 id=\"RBAC权限设计\"><a href=\"#RBAC权限设计\" class=\"headerlink\" title=\"RBAC权限设计\"></a>RBAC权限设计</h2><h4 id=\"RBAC-Role-Based-Access-Control-–-基于角色（Role）的访问控制\"><a href=\"#RBAC-Role-Based-Access-Control-–-基于角色（Role）的访问控制\" class=\"headerlink\" title=\"RBAC (Role-Based Access Control – 基于角色（Role）的访问控制)\"></a>RBAC (Role-Based Access Control – 基于角色（Role）的访问控制)</h4><p>简单来说，就是通过将<strong>权限</strong>分配给-&gt;<strong>角色</strong>，再将<strong>角色</strong>分配给-&gt;<strong>用户</strong>，来实现对系统资源的访问控制</p>\n<p>一个用户拥有若干角色，每一个角色拥有若干权限。这样，就构造成“用户-角色-权限”的授权模型。在这种模型中，<strong>用户与角色之间，角色与权限之间，一般者是多对多的关系</strong></p>\n<ol>\n<li><strong>角色（Role）</strong>：角色是指在系统中具有一组相关权限的抽象概念，代表了用户在特定上下文中的身份或职能，例如管理员、普通用户等。</li>\n<li><strong>权限（Permission）</strong>：权限是指对系统资源进行操作的许可，如读取、写入、修改等。权限可以被分配给角色。</li>\n<li><strong>用户（User）</strong>：用户是指系统的实际使用者，每个用户可以被分配一个或多个角色。</li>\n<li><strong>分配（Assignment）</strong>：分配是指将角色与用户关联起来，以赋予用户相应的权限。</li>\n</ol>\n<p><strong>权限控制流程</strong></p>\n<p><img src=\"https://raw.githubusercontent.com/Myprefer/ImageHost/main/20241006143101.png\"></p>\n<p><strong>权限表</strong></p>\n<p><img src=\"https://raw.githubusercontent.com/Myprefer/ImageHost/main/20241006143140.png\"></p>\n","text":"FastAPI项目 从构建到部署项目框架基本结构FastAPI 路由, 视图 APIRouter Include_router Jinja2 中间件 cooki...","permalink":"/post/FastAPI项目-从构建到部署","photos":[],"count_time":{"symbolsCount":"7.5k","symbolsTime":"7 mins."},"categories":[],"tags":[],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#FastAPI%E9%A1%B9%E7%9B%AE-%E4%BB%8E%E6%9E%84%E5%BB%BA%E5%88%B0%E9%83%A8%E7%BD%B2\"><span class=\"toc-text\">FastAPI项目 从构建到部署</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%A1%B9%E7%9B%AE%E6%A1%86%E6%9E%B6%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84\"><span class=\"toc-text\">项目框架基本结构</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84\"><span class=\"toc-text\">项目架构</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80%E6%9E%84%E5%BB%BA\"><span class=\"toc-text\">项目基础构建</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC\"><span class=\"toc-text\">事件监听</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%BC%82%E5%B8%B8%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86\"><span class=\"toc-text\">异常错误处理</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%B7%AF%E7%94%B1\"><span class=\"toc-text\">路由</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%B8%AD%E9%97%B4%E4%BB%B6\"><span class=\"toc-text\">中间件</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%B7%AF%E7%94%B1-1\"><span class=\"toc-text\">路由</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#ORM%E6%95%B0%E6%8D%AE%E5%BA%93\"><span class=\"toc-text\">ORM数据库</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">数据库配置</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%A1%E5%9E%8B%E7%A4%BA%E4%BE%8B\"><span class=\"toc-text\">数据库模型示例</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93Redis\"><span class=\"toc-text\">缓存数据库Redis</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">连接配置</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2\"><span class=\"toc-text\">数据库查询</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%AD%E9%97%B4%E4%BB%B6-1\"><span class=\"toc-text\">中间件</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Session\"><span class=\"toc-text\">Session</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#RBAC%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1\"><span class=\"toc-text\">RBAC权限设计</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#RBAC-Role-Based-Access-Control-%E2%80%93-%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%EF%BC%88Role%EF%BC%89%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6\"><span class=\"toc-text\">RBAC (Role-Based Access Control – 基于角色（Role）的访问控制)</span></a></li></ol></li></ol></li></ol></li></ol>","author":{"name":"Myprefer","slug":"blog-author","avatar":"https://gravatar.com/avatar/d195051819ce742212020a79d768fb6c?size=256&cache=1710768150791","link":"https://github.com/Myprefer","description":"web security learner, ML learner","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"ML 数据增强","uid":"0598f467e802a4ba91894d2f84383293","slug":"ML-数据增强","date":"2025-02-06T08:52:43.000Z","updated":"2025-02-06T09:21:33.123Z","comments":true,"path":"api/articles/ML-数据增强.json","keywords":null,"cover":[],"text":"数据增强概念在训练集中使用图像增广，随机改变训练样本可以减少模型对某些属性（如位置、颜色等）的依赖，尽可能地模拟现场部署时的场景，提高模型的泛化性能 方法语音数...","permalink":"/post/ML-数据增强","photos":[],"count_time":{"symbolsCount":116,"symbolsTime":"1 mins."},"categories":[],"tags":[],"author":{"name":"Myprefer","slug":"blog-author","avatar":"https://gravatar.com/avatar/d195051819ce742212020a79d768fb6c?size=256&cache=1710768150791","link":"https://github.com/Myprefer","description":"web security learner, ML learner","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"ML 理论基础","uid":"23f2ddd5bdc180cd3f2c05e6b37a137d","slug":"ML-理论基础","date":"2024-09-07T16:31:52.000Z","updated":"2024-09-07T16:32:29.053Z","comments":true,"path":"api/articles/ML-理论基础.json","keywords":null,"cover":[],"text":"理论基础讨论前向传播和反向传播的流程？前向传播 在输入层输入特征向量, 传递到隐藏层 在隐藏层不断计算出每一层神经元得到的结果 通过激活函数得到的输出 将输出传...","permalink":"/post/ML-理论基础","photos":[],"count_time":{"symbolsCount":"6.2k","symbolsTime":"6 mins."},"categories":[],"tags":[],"author":{"name":"Myprefer","slug":"blog-author","avatar":"https://gravatar.com/avatar/d195051819ce742212020a79d768fb6c?size=256&cache=1710768150791","link":"https://github.com/Myprefer","description":"web security learner, ML learner","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}